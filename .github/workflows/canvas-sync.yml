name: Canvas Assignment Sync

on:
  push:
    branches:
      - main
    paths:
      - '**.md'

jobs:
  sync-canvas:
    runs-on: ubuntu-latest
    # Use Docker container with R and common packages pre-installed
    container:
      image: rocker/tidyverse:latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need at least 2 commits for git diff
      
      - name: Setup SSH for private submodule
        run: |
          # Install openssh-client if not available (needed for SSH in Docker)
          apt-get update -qq && apt-get install -y -qq openssh-client > /dev/null 2>&1 || true
          
          # Check if SSH key secret exists and is not empty
          SSH_KEY="${{ secrets.SUBMODULE_SSH_KEY }}"
          
          # Trim whitespace and check if empty (using basic shell, not sed)
          SSH_KEY=$(echo "$SSH_KEY" | xargs)
          
          if [ -z "$SSH_KEY" ] || [ "$SSH_KEY" = "" ]; then
            echo "SUBMODULE_SSH_KEY secret not found or empty. Assuming canvastest is public or using HTTPS."
            exit 0
          fi
          
          # Validate that the key looks like a valid SSH private key
          if ! echo "$SSH_KEY" | grep -q "BEGIN.*PRIVATE KEY"; then
            echo "Warning: SUBMODULE_SSH_KEY does not appear to be a valid SSH private key."
            echo "Skipping SSH setup. Submodule checkout will use HTTPS."
            exit 0
          fi
          
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write the key file, ensuring proper line endings
          printf '%s\n' "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Validate the key file was created correctly
          if [ ! -s ~/.ssh/id_rsa ]; then
            echo "Error: SSH key file is empty or was not created correctly."
            exit 1
          fi
          
          # Validate key format
          if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/id_rsa; then
            echo "Error: SSH key file does not contain valid private key format."
            exit 1
          fi
          
          # Add GitHub to known hosts
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 600 ~/.ssh/known_hosts
          
          # Start SSH agent and add key
          eval "$(ssh-agent -s)"
          
          # Try to add the key and capture output
          if ! ssh-add ~/.ssh/id_rsa 2>&1; then
            echo "Error: Failed to add SSH key to agent."
            echo "Key file contents (first 100 chars):"
            head -c 100 ~/.ssh/id_rsa || echo "Could not read key file"
            echo ""
            echo "This may indicate the key is invalid, corrupted, or improperly formatted."
            exit 1
          fi
          
          # Configure git to use SSH for canvastest submodule
          git config --file=.gitmodules submodule.canvastest.url git@github.com:timothyfraser/canvastest.git
          echo "SSH setup completed successfully."
      
      - name: Checkout submodules
        run: |
          git submodule sync
          if ! git submodule update --init --recursive; then
            echo "Submodule checkout failed."
            echo "If canvastest is private, ensure:"
            echo "  1. SUBMODULE_SSH_KEY secret is configured correctly"
            echo "  2. The SSH key includes BEGIN/END markers and all lines"
            echo "  3. The deploy key is added to the canvastest repository"
            exit 1
          fi
        
      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/lib/R/site-library
          key: ${{ runner.os }}-r-packages-${{ hashFiles('**/canvastest/R/*.R') }}
          restore-keys: |
            ${{ runner.os }}-r-packages-
      
      - name: Install R dependencies
        run: |
          # rocker/tidyverse already includes dplyr and readr
          # Only install missing packages (with caching)
          Rscript -e "if (!require('httr2', quietly = TRUE)) install.packages('httr2', repos = 'https://cloud.r-project.org')"
          Rscript -e "if (!require('jsonlite', quietly = TRUE)) install.packages('jsonlite', repos = 'https://cloud.r-project.org')"
        
      - name: Detect changed assignment files
        id: changed-files
        run: |
          # Get list of changed .md files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.md$' || true)
          
          # Filter to assignment files matching patterns
          ASSIGNMENT_FILES=""
          for file in $CHANGED_FILES; do
            filename=$(basename "$file")
            if [[ "$filename" =~ ^(ACTIVITY_|LAB_|HOMEWORK|TOOL) ]]; then
              ASSIGNMENT_FILES="${ASSIGNMENT_FILES}${file}\n"
            fi
          done
          
          # Remove trailing newline and save to file
          echo -e "$ASSIGNMENT_FILES" | sed '/^$/d' > changed_assignments.txt
          
          # Count files
          FILE_COUNT=$(wc -l < changed_assignments.txt | tr -d ' ')
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          
          # Display found files (for debugging, but don't log full paths if empty)
          if [ "$FILE_COUNT" -gt 0 ]; then
            echo "Found $FILE_COUNT changed assignment file(s):"
            cat changed_assignments.txt
          else
            echo "No changed assignment files found"
          fi
        
      - name: Create .env file
        run: |
          echo "CANVAS_API_KEY=${{ secrets.CANVAS_API_KEY }}" > .env
          # Ensure .env is not logged
          echo "Created .env file (contents hidden for security)"
        
      - name: Create course_config.json
        run: |
          cat > course_config.json << EOF
          {
            "canvas": {
              "base_url": "https://canvas.cornell.edu",
              "course_id": ${{ secrets.CANVAS_COURSE_ID }}
            },
            "github": {
              "repo": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}"
            },
            "files": {
              "metadata_file": "canvastest/assignments_metadata_5381.json"
            }
          }
          EOF
          echo "Created course_config.json"
        
      - name: Check if assignments_metadata_5381.json exists
        id: check-metadata
        run: |
          if [ -f "canvastest/assignments_metadata_5381.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Found assignments_metadata_5381.json"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Warning: assignments_metadata_5381.json not found in canvastest submodule."
            echo "This file must exist in the private canvastest repository."
          fi
        
      - name: Sync changed files to Canvas
        if: steps.changed-files.outputs.file_count > 0 && steps.check-metadata.outputs.exists == 'true'
        run: |
          # Use the sync script from canvastest/scripts directory
          Rscript canvastest/scripts/sync_changed_files.R \
            changed_assignments.txt \
            course_config.json \
            canvastest/assignments_metadata_5381.json
        
      - name: Report skipped (no changed files)
        if: steps.changed-files.outputs.file_count == 0
        run: |
          echo "No assignment files changed. Skipping Canvas sync."
        
      - name: Report skipped (no metadata)
        if: steps.changed-files.outputs.file_count > 0 && steps.check-metadata.outputs.exists == 'false'
        run: |
          echo "Warning: assignments_metadata_5381.json not found. Cannot sync files."
          echo "Please ensure canvastest/assignments_metadata_5381.json exists in the private canvastest repository."
          echo "Also verify SUBMODULE_SSH_KEY secret is configured for private submodule access."
